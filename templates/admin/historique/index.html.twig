{# filepath: c:\Users\Hp\Biblio-Project\biblio-project-backend\templates\admin\historique\index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Historique des Emprunts{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        body {
            background: linear-gradient(135deg, #fdfaf5 0%, #f8f5f0 100%) !important;
        }

        .container {
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin: 2rem auto;
            max-width: 1200px;
        }

        h1 {
            color: #1a2e4f;
            font-family: 'Georgia', serif;
            font-weight: bold;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2.5rem;
        }

        /* SEARCH SECTION - Similar to catalog */
        .search-filter-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            border-left: 5px solid #b2903e;
        }

        .search-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a2e4f;
            font-family: 'Georgia', serif;
            margin-bottom: 1.5rem;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .search-group {
            flex: 1;
            min-width: 280px;
        }

        .search-group label {
            display: block;
            font-weight: 600;
            color: #1a2e4f;
            font-family: 'Georgia', serif;
            margin-bottom: 0.6rem;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-group input,
        .search-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Georgia', serif;
            transition: all 0.3s ease;
            font-size: 0.95em;
            background: white;
        }

        .search-group input::placeholder {
            color: #999;
        }

        .search-group input:focus,
        .search-group select:focus {
            border-color: #b2903e;
            box-shadow: 0 0 0 0.2rem rgba(178, 144, 62, 0.25);
            outline: none;
            background: #fffbf7;
        }

        /* Filter Options - Radio Buttons Style */
        .filter-options {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Georgia', serif;
            color: #1a2e4f;
            cursor: pointer;
        }

        .filter-option input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #b2903e;
        }

        .filter-option label {
            margin: 0 !important;
            cursor: pointer;
            font-weight: 500;
        }

        .filter-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-search,
        .btn-reset {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-family: 'Georgia', serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.95em;
        }

        .btn-search {
            background: linear-gradient(135deg, #b2903e, #9b7e46);
            color: white;
        }

        .btn-search:hover {
            background: linear-gradient(135deg, #9b7e46, #7d6435);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-reset:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .export-btn {
            text-align: right;
            margin-bottom: 1.5rem;
        }

        .btn-export {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-family: 'Georgia', serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.95em;
        }

        .btn-export:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Results Info */
        .results-info {
            background: linear-gradient(135deg, #f0f7ff, #e8f4ff);
            border-left: 4px solid #b2903e;
            padding: 1.2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-family: 'Georgia', serif;
            color: #1a2e4f;
        }

        .results-info strong {
            color: #b2903e;
            font-weight: 700;
        }

        .results-info i {
            color: #b2903e;
            margin-right: 0.5rem;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        table th,
        table td {
            padding: 14px 16px;
            border: 1px solid #e9ecef;
            text-align: left;
            font-family: 'Georgia', serif;
        }

        table th {
            background: linear-gradient(135deg, #1a2e4f, #2a3f5f);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        table th i {
            margin-right: 0.5rem;
        }

        table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e9ecef;
        }

        table tbody tr:hover {
            background-color: #fdfaf5;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        table td {
            color: #333;
            font-size: 0.95em;
        }

        table small {
            display: block;
            color: #7a6b52;
            font-size: 0.85em;
            margin-top: 0.3rem;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 0.3rem;
        }

        .badge-returned {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge-borrowed {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 3rem 2rem;
            color: #7a6b52;
            background: #fff;
            border-radius: 8px;
            border-left: 5px solid #b2903e;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .no-results i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #b2903e;
            opacity: 0.7;
        }

        .no-results p {
            font-family: 'Georgia', serif;
            font-size: 1.1em;
            margin: 0;
        }

        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }

            .search-group {
                min-width: 100%;
            }

            .filter-options {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-buttons {
                flex-direction: column;
                gap: 0.8rem;
            }

            .btn-search,
            .btn-reset {
                width: 100%;
                justify-content: center;
            }

            table {
                font-size: 0.9em;
            }

            table th,
            table td {
                padding: 10px 12px;
            }

            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <h1><i class="fas fa-history"></i> Historique des Emprunts</h1>

    <!-- Search & Filter Section -->
    <div class="search-filter-section">
        <div class="search-title">Recherche dans l'historique</div>

        <form method="GET" action="{{ path('admin_historique_index') }}" id="filterForm">
            <div class="search-container">
                <!-- Global Search -->
                <div class="search-group" style="flex: 2;">
                    <label for="globalSearch">
                        <i class="fas fa-search"></i> Recherche
                    </label>
                    <input type="text" 
                           id="globalSearch" 
                           name="search" 
                           placeholder="Lecteur (nom complet), email, titre du livre ou code-barres..." 
                           value="{{ searchQuery|default('') }}"
                           class="search-input">
                </div>

                <!-- Status Filter -->
                <div class="search-group">
                    <label for="statusFilter">
                        <i class="fas fa-filter"></i> Statut
                    </label>
                    <select id="statusFilter" name="status">
                        <option value="">Tous les statuts</option>
                        <option value="borrowed" {% if filterStatus == 'borrowed' %}selected{% endif %}>En prêt</option>
                        <option value="available" {% if filterStatus == 'available' %}selected{% endif %}>Retourné</option>
                    </select>
                </div>
            </div>

            <!-- Search Type Options -->
            <div class="filter-options">
                <div class="filter-option">
                    <input type="radio" id="searchAll" name="searchType" value="all" 
                           {% if searchType == 'all' or searchType is empty %}checked{% endif %}>
                    <label for="searchAll">Recherche globale</label>
                </div>
                <div class="filter-option">
                    <input type="radio" id="searchLecteur" name="searchType" value="lecteur" 
                           {% if searchType == 'lecteur' %}checked{% endif %}>
                    <label for="searchLecteur">Par Lecteur</label>
                </div>
                <div class="filter-option">
                    <input type="radio" id="searchExemplaire" name="searchType" value="exemplaire" 
                           {% if searchType == 'exemplaire' %}checked{% endif %}>
                    <label for="searchExemplaire">Par Exemplaire</label>
                </div>
            </div>

            <!-- Filter Buttons -->
            <div class="filter-buttons">
                <button type="submit" class="btn-search">
                    <i class="fas fa-search"></i> Rechercher
                </button>
                <a href="{{ path('admin_historique_index') }}" class="btn-reset">
                    <i class="fas fa-redo"></i> Réinitialiser
                </a>
            </div>
        </form>
    </div>

    <!-- Results Info -->
    {% if searchQuery or filterStatus or searchType != 'all' %}
        <div class="results-info">
            <i class="fas fa-info-circle"></i>
            Résultats de la recherche : <strong>{{ approvedOrders|length }}</strong> emprunt(s) trouvé(s)
            {% if searchQuery %}
                pour "<strong>{{ searchQuery }}</strong>"
            {% endif %}
            {% if searchType != 'all' %}
                (Recherche par <strong>{{ searchType == 'lecteur' ? 'Lecteur' : 'Exemplaire' }}</strong>)
            {% endif %}
        </div>
    {% endif %}

    <!-- Export Button -->
    <div class="export-btn">
        <a href="{{ path('admin_historique_export') }}" class="btn-export">
            <i class="fas fa-download"></i> Exporter en CSV
        </a>
    </div>

    <!-- Table -->
    {% if approvedOrders is not empty %}
        <table>
            <thead>
                <tr>
                    <th><i class="fas fa-user"></i> Lecteur</th>
                    <th><i class="fas fa-calendar"></i> Date de commande</th>
                    <th><i class="fas fa-calendar-check"></i> Date de retour</th>
                    <th><i class="fas fa-book"></i> Exemplaire</th>
                    <th><i class="fas fa-map-marker-alt"></i> Emplacement</th>
                    <th><i class="fas fa-user-check"></i> Admin traitant</th>
                </tr>
            </thead>
            <tbody>
                {% for order in approvedOrders %}
                    {% for item in order.items %}
                    <tr>
                        <td>
                            <strong>{{ order.lecteur.nom }} {{ order.lecteur.prenom }}</strong><br>
                            <small>{{ order.lecteur.email }}</small>
                        </td>
                        <td>{{ order.placedAt|date('d/m/Y H:i') }}</td>
                        <td>
                            {% if order.returnedAt %}
                                {{ order.returnedAt|date('d/m/Y H:i') }}
                            {% else %}
                                <span style="color: #ffc107; font-weight: bold;">Non retourné</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ item.exemplaire.book.title }}</strong><br>
                            <small>Code: {{ item.exemplaire.barcode }}</small>
                            {% if item.exemplaire.status == 'available' %}
                                <span class="status-badge badge-returned">
                                    <i class="fas fa-check"></i> Retourné
                                </span>
                            {% elseif item.exemplaire.status == 'borrowed' %}
                                <span class="status-badge badge-borrowed">
                                    <i class="fas fa-clock"></i> En prêt
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.exemplaire.location %}
                                {{ item.exemplaire.location.name }}
                            {% else %}
                                <span style="color: #999;">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.processedBy %}
                                {{ order.processedBy.email }}<br>
                                <small>{{ order.processedAt ? order.processedAt|date('d/m/Y H:i') : '' }}</small>
                            {% else %}
                                <span style="color: #999;">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="no-results">
            <i class="fas fa-inbox"></i>
            <p>Aucun emprunt trouvé correspondant à votre recherche.</p>
        </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.getElementById('filterForm');
        const globalSearch = document.getElementById('globalSearch');

        // Auto-submit on Enter key
        globalSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterForm.submit();
            }
        });

        // Optional: Switch placeholder text based on search type
        const searchTypeRadios = document.querySelectorAll('input[name="searchType"]');
        searchTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'lecteur') {
                    globalSearch.placeholder = 'Nom complet ou email du lecteur...';
                } else if (this.value === 'exemplaire') {
                    globalSearch.placeholder = 'Titre du livre ou code-barres...';
                } else {
                    globalSearch.placeholder = 'Lecteur (nom complet), email, titre du livre ou code-barres...';
                }
            });
        });
    });
</script>
{% endblock %}