# security:
#     password_hashers:
#         Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'
#     providers:
#         users_in_memory:
#             memory:
#                  users:
#                     user1:
#                         password: password123
#                         roles: ROLE_USER
#         app_user_provider:
#             entity:
#                 class: App\Entity\User
#                 property: email
#     firewalls:
#         dev:
#             pattern: ^/(_(profiler|wdt)|css|images|js)/
#             security: false
#         main:
#             lazy: true
#             provider: app_user_provider
#             stateless: false
#             entry_point: form_login
#             http_basic:
#                 realm: Secured Area
#             # json_login:
#             #     check_path: /api/login
#             #     username_path: email
#             #     password_path: password
#             form_login:
#                 login_path: app_login
#                 check_path: app_login
#                 enable_csrf: true
#             logout:
#                 path: app_logout
#                 target: app_homepage
#             # Replace "anonymous: true" with the following:
#             security: true

#     access_control:
#         - { path: ^/admin, roles: ROLE_ADMIN }
#         - { path: ^/profile, roles: ROLE_USER }
#         - { path: ^/student, roles: ROLE_STUDENT }

# when@test:
#     security:
#         password_hashers:
#             Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface:
#                 algorithm: auto
#                 cost: 4
#                 time_cost: 3
#                 memory_cost: 10
security:
  enable_authenticator_manager: true
  password_hashers:
    App\Entity\User: "auto"
    App\Entity\Lecteur: "plaintext"

  providers:
    admin_provider:
      entity:
        class: App\Entity\User
        property: login # admin form: <input name="login">
    lecteur_provider:
      entity:
        class: App\Entity\Lecteur
        property: codeAdmission # lecteur form: <input name="code_d_admission">
    chain_provider:
      chain:
        providers: ["admin_provider", "lecteur_provider"]

  role_hierarchy:
    ROLE_ADMIN: [ROLE_USER]
    # ROLE_LIMITED_ADMIN does NOT inherit ROLE_USER - they are restricted to admin panel only

  firewalls:
    dev:
      pattern: ^/(_(profiler|wdt)|css|images|js)/
      security: false

    admin:
      pattern: ^/admin
      provider: admin_provider
      context: shared_context
      form_login:
        success_handler: App\Security\LoginSuccessHandler
        login_path: app_admin_login
        check_path: app_admin_check
        username_parameter: login
        password_parameter: password
        enable_csrf: true
        default_target_path: admin_dashboard
        use_referer: false
      logout:
        path: /admin/logout
        target: app_admin_login

    main:
      pattern: ^/
      provider: chain_provider
      context: shared_context
      form_login:
        success_handler: App\Security\LoginSuccessHandler
        login_path: app_login
        check_path: app_login
        username_parameter: codeAdmission
        password_parameter: password
        enable_csrf: true
        default_target_path: lecteur_dashboard
        use_referer: true
      logout:
        path: app_logout
        target: app_login
      switch_user: true

  access_control:
    # Public routes
    - { path: ^/login, roles: PUBLIC_ACCESS }
    - { path: ^/admin/login, roles: PUBLIC_ACCESS }
    - { path: ^/admin/logout, roles: PUBLIC_ACCESS }

    # Admin routes - accessible to both ROLE_ADMIN and ROLE_LIMITED_ADMIN
    - { path: ^/admin/panel, roles: ROLE_LIMITED_ADMIN }
    - { path: ^/admin, roles: [ROLE_ADMIN, ROLE_LIMITED_ADMIN] }

    # Block LIMITED_ADMIN from accessing main site routes - also require authentication
    - {
        path: ^/main-site,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }
    - {
        path: ^/my-cart,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }
    - {
        path: ^/cart,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }
    - {
        path: ^/submit-cart,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }
    - {
        path: ^/add-to-cart,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }
    - {
        path: ^/remove-from-cart,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }
    - {
        path: ^/mon-compte,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }

    # Main site - require authentication and block LIMITED_ADMIN
    - {
        path: ^/,
        roles: IS_AUTHENTICATED_FULLY,
        allow_if: "not is_granted('ROLE_LIMITED_ADMIN') or is_granted('ROLE_ADMIN')",
      }
